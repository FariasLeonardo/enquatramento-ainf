<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DIFAL Não Contribuinte</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            line-height: 1.6;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .bloco {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        p {
            margin: 10px 0;
            text-align: justify;
        }
        .form-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #0066cc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background-color: #004d99;
        }
        #notas-container, #calculo-container {
            margin-top: 20px;
        }
        .nota-section, .calculo-section {
            border: 1px dashed #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            position: relative;
        }
        .aliquota-section {
            border: 1px dotted #999;
            padding: 5px;
            margin: 5px 0;
            position: relative;
        }
        .remove-btn {
            background-color: #cc0000;
            padding: 5px 10px;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .remove-btn:hover {
            background-color: #990000;
        }
        #referencia-nf {
            font-weight: bold;
            color: #0066cc;
            text-align: justify;
        }
        #infrigencia_texto {
            text-align: justify;
        }
        .checkbox-group {
            margin-bottom: 15px;
        }
        .checkbox-group label {
            display: inline-block;
            margin-right: 15px;
        }
        .header {
            margin-bottom: 20px;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
        }
        /* Ajuste para reduzir o espaçamento na metodologia de cálculo */
        #calculo_difal p {
            margin: 2px 0; /* Espaçamento mínimo entre linhas */
            line-height: 1.2; /* Reduz a altura das linhas */
        }
    </style>
</head>
<body>
    <div class="header">
        <button onclick="voltarPaginaAnterior()">Voltar</button>
    </div>

    <div class="form-container">
        <h2>Insira as Informações</h2>
        <div id="notas-container">
            <div class="nota-section" id="nota-1">
                <label for="nf-1">Número da Nota Fiscal:</label>
                <input type="text" id="nf-1" placeholder="Digite o número da NF">
                <button class="remove-btn" onclick="removerNota(1)" style="display: none;">Remover</button>
            </div>
        </div>
        <button onclick="adicionarNota()">Adicionar Nova Nota Fiscal</button>

        <div id="calculo-container">
            <h3>Dados para Cálculo do ICMS Diferença de Alíquota</h3>
            <div id="calculo-notas">
                <div class="calculo-section" id="calculo-nota-1">
                    
                    <label for="valor_total-1">Valor Total da Operação Interestadual (R$):</label>
                    <input type="text" id="valor_total-1" placeholder="Ex: 45752.52 ou 45.752,52">
                    <label for="uf_origem-1">Unidade da Federação/Região de Origem:</label>
                    <input type="text" id="uf_origem-1" placeholder="Ex: SP">
                    <div id="aliquotas-1">
                        <div class="aliquota-section" id="aliquota-1-1">
                            <label for="aliquota_inter-1-1">Alíquota Interestadual (%):</label>
                            <input type="text" id="aliquota_inter-1-1" placeholder="Ex: 7 ou 7,00">
                            <button class="remove-btn" onclick="removerAliquota(1, 1)" style="display: none;">Remover</button>
                        </div>
                    </div>
                    <button onclick="adicionarAliquota(1)">Adicionar Alíquota</button>
                    <label for="icms_destacado-1">ICMS Destacado Total na NF (R$):</label>
                    <input type="text" id="icms_destacado-1" placeholder="Ex: 686 ou 686,00">
                    <button class="remove-btn" onclick="removerCalculoNota(1)" style="display: none;">Remover NF</button>
                </div>
            </div>
            <button onclick="adicionarCalculoNota()">Adicionar Nova Nota Fiscal</button>
            <label for="aliquota_interna">Alíquota Interna (%):</label>
            <input type="text" id="aliquota_interna" placeholder="Ex: 19 ou 19,00">
        </div>

        <button onclick="atualizarTexto()">Gerar Texto</button>
    </div>

    <div class="bloco">
        <h2>Ocorrência</h2>
        <p id="referencia-nf">Referente à nota fiscal: [VALOR_DANFE]</p>
        <p id="texto_ocorrencia">Durante operação de fiscalização realizada no Posto Fiscal de Itinga, o condutor apresentou o DANFE listado acima, referente a mercadoria destinada a uma pessoa jurídica ou física não contribuinte do ICMS. Não foi identificado o pagamento do Diferencial de Alíquotas (DIFAL) devido, que deveria ter sido recolhido em favor do Estado do Pará. Em razão disso, foi lavrado o presente termo para cobrança do DIFAL devido. Conforme o artigo 6º da Lei Estadual nº 8.315/2015, o valor do próprio imposto integra sua base de cálculo. Assim, o cálculo do imposto, correspondente à diferença entre a alíquota interna e a interestadual, seguirá os artigos 6º e 7º da mesma lei, em conformidade com a Cláusula Segunda, §1º, do Convênio ICMS 236/2021, combinada com o §1º do artigo 13 da Lei Complementar nº 87/1996.</p>
        <div id="calculo_difal"></div>
    </div>

    <div class="bloco">
        <h2>Infrigência</h2>
        <p id="infrigencia_texto">
            - Constituição Federal de 1988, Artigo 155, §2º, incisos VII e VIII, alínea "b";<br>
            - Lei Estadual nº 5.530/1989, Artigo 2º, §3º, Artigo 62 e Artigo 78, inciso I, alínea "e";<br>
            - Lei Estadual nº 8.315/2015, Artigo 1º, Artigo 2º (caput e parágrafo único, inciso II), Artigos 6º, 7º (incisos I, II, III e IV), e Artigos 10 e 11;<br>
            - Convênio ICMS 236/2021;<br>
            - Regulamento do ICMS, aprovado pelo Decreto nº 4.676/2001, Artigo 108, §3º, e Artigo 115, inciso I;<br>
            - Lei Complementar nº 190/2022.
        </p>
    </div>

    <div class="footer">
        <button onclick="limpar()">Limpar</button>
    </div>

    <script>
        let notaCount = 1;
        let calculoNotaCount = 1;
        let aliquotaCounts = { 1: 1 }; // Contador de alíquotas por nota

        // Função para formatar valores em reais
        function formatarReais(valor) {
            return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Função para formatar percentuais na saída
        function formatarPercentual(valor) {
            return Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%';
        }

        // Adiciona uma nova nota fiscal
        function adicionarNota() {
            notaCount++;
            const container = document.getElementById("notas-container");
            const newNota = document.createElement('div');
            newNota.className = "nota-section";
            newNota.id = `nota-${notaCount}`;
            newNota.innerHTML = `
                <label for="nf-${notaCount}">Número da Nota Fiscal:</label>
                <input type="text" id="nf-${notaCount}" placeholder="Digite o número da NF">
                <button class="remove-btn" onclick="removerNota(${notaCount})">Remover</button>
            `;
            container.appendChild(newNota);
            atualizarBotoesRemover('nota');
        }

        // Remove uma nota fiscal
        function removerNota(id) {
            const nota = document.getElementById(`nota-${id}`);
            if (nota) nota.remove();
            atualizarBotoesRemover('nota');
        }

        // Adiciona uma nova nota fiscal para cálculo
        function adicionarCalculoNota() {
            calculoNotaCount++;
            aliquotaCounts[calculoNotaCount] = 1;
            const container = document.getElementById("calculo-notas");
            const newCalculoNota = document.createElement('div');
            newCalculoNota.className = "calculo-section";
            newCalculoNota.id = `calculo-nota-${calculoNotaCount}`;
            const nfValue = document.getElementById(`nf-${calculoNotaCount}`).value || "NÃO INFORMADO";
            newCalculoNota.innerHTML = `
                <label for="calculo-nf-${calculoNotaCount}">Número da Nota Fiscal:</label>
                <input type="text" id="calculo-nf-${calculoNotaCount}" value="${nfValue}" placeholder="Preenchido automaticamente" readonly>
                <label for="valor_total-${calculoNotaCount}">Valor Total da Operação Interestadual (R$):</label>
                <input type="text" id="valor_total-${calculoNotaCount}" placeholder="Ex: 45752.52 ou 45.752,52">
                <label for="uf_origem-${calculoNotaCount}">Unidade da Federação/Região de Origem:</label>
                <input type="text" id="uf_origem-${calculoNotaCount}" placeholder="Ex: SP">
                <div id="aliquotas-${calculoNotaCount}">
                    <div class="aliquota-section" id="aliquota-${calculoNotaCount}-1">
                        <label for="aliquota_inter-${calculoNotaCount}-1">Alíquota Interestadual (%):</label>
                        <input type="text" id="aliquota_inter-${calculoNotaCount}-1" placeholder="Ex: 7 ou 7,00">
                        <button class="remove-btn" onclick="removerAliquota(${calculoNotaCount}, 1)" style="display: none;">Remover</button>
                    </div>
                </div>
                <button onclick="adicionarAliquota(${calculoNotaCount})">Adicionar Alíquota</button>
                <label for="icms_destacado-${calculoNotaCount}">ICMS Destacado Total na NF (R$):</label>
                <input type="text" id="icms_destacado-${calculoNotaCount}" placeholder="Ex: 686 ou 686,00">
                <button class="remove-btn" onclick="removerCalculoNota(${calculoNotaCount})">Remover NF</button>
            `;
            container.appendChild(newCalculoNota);
            atualizarBotoesRemover('calculo-nota');
        }

        // Remove uma nota fiscal do cálculo
        function removerCalculoNota(id) {
            const nota = document.getElementById(`calculo-nota-${id}`);
            if (nota) nota.remove();
            delete aliquotaCounts[id];
            atualizarBotoesRemover('calculo-nota');
        }

        // Adiciona uma nova alíquota para uma nota fiscal
        function adicionarAliquota(notaId) {
            aliquotaCounts[notaId] = (aliquotaCounts[notaId] || 0) + 1;
            const container = document.getElementById(`aliquotas-${notaId}`);
            const aliquotaId = aliquotaCounts[notaId];
            const newAliquota = document.createElement('div');
            newAliquota.className = "aliquota-section";
            newAliquota.id = `aliquota-${notaId}-${aliquotaId}`;
            newAliquota.innerHTML = `
                <label for="aliquota_inter-${notaId}-${aliquotaId}">Alíquota Interestadual (%):</label>
                <input type="text" id="aliquota_inter-${notaId}-${aliquotaId}" placeholder="Ex: 7 ou 7,00">
                <button class="remove-btn" onclick="removerAliquota(${notaId}, ${aliquotaId})">Remover</button>
            `;
            container.appendChild(newAliquota);
            atualizarBotoesRemoverAliquota(notaId);
        }

        // Remove uma alíquota
        function removerAliquota(notaId, aliquotaId) {
            const aliquota = document.getElementById(`aliquota-${notaId}-${aliquotaId}`);
            if (aliquota) aliquota.remove();
            atualizarBotoesRemoverAliquota(notaId);
        }

        // Atualiza visibilidade dos botões "Remover" para notas
        function atualizarBotoesRemover(prefix) {
            const notas = document.querySelectorAll(`.${prefix}-section`);
            notas.forEach((nota, index) => {
                const btn = nota.querySelector(".remove-btn");
                btn.style.display = notas.length > 1 ? "inline-block" : "none";
            });
        }

        // Atualiza visibilidade dos botões "Remover" para alíquotas
        function atualizarBotoesRemoverAliquota(notaId) {
            const aliquotas = document.querySelectorAll(`#aliquotas-${notaId} .aliquota-section`);
            aliquotas.forEach((aliquota, index) => {
                const btn = aliquota.querySelector(".remove-btn");
                btn.style.display = aliquotas.length > 1 ? "inline-block" : "none";
            });
        }

        // Função para limpar
        function limpar() {
            // Reinicia contadores
            notaCount = 1;
            calculoNotaCount = 1;
            aliquotaCounts = { 1: 1 };

            // Limpa as seções de notas e cálculos
            document.getElementById("notas-container").innerHTML = `
                <div class="nota-section" id="nota-1">
                    <label for="nf-1">Número da Nota Fiscal:</label>
                    <input type="text" id="nf-1" placeholder="Digite o número da NF">
                    <button class="remove-btn" onclick="removerNota(1)" style="display: none;">Remover</button>
                </div>
            `;
            document.getElementById("calculo-notas").innerHTML = `
                <div class="calculo-section" id="calculo-nota-1">
                    <label for="calculo-nf-1">Número da Nota Fiscal:</label>
                    <input type="text" id="calculo-nf-1" placeholder="Preenchido automaticamente" readonly>
                    <label for="valor_total-1">Valor Total da Operação Interestadual (R$):</label>
                    <input type="text" id="valor_total-1" placeholder="Ex: 45752.52 ou 45.752,52">
                    <label for="uf_origem-1">Unidade da Federação/Região de Origem:</label>
                    <input type="text" id="uf_origem-1" placeholder="Ex: SP">
                    <div id="aliquotas-1">
                        <div class="aliquota-section" id="aliquota-1-1">
                            <label for="aliquota_inter-1-1">Alíquota Interestadual (%):</label>
                            <input type="text" id="aliquota_inter-1-1" placeholder="Ex: 7 ou 7,00">
                            <button class="remove-btn" onclick="removerAliquota(1, 1)" style="display: none;">Remover</button>
                        </div>
                    </div>
                    <button onclick="adicionarAliquota(1)">Adicionar Alíquota</button>
                    <label for="icms_destacado-1">ICMS Destacado Total na NF (R$):</label>
                    <input type="text" id="icms_destacado-1" placeholder="Ex: 686 ou 686,00">
                    <button class="remove-btn" onclick="removerCalculoNota(1)" style="display: none;">Remover NF</button>
                </div>
            `;
            document.getElementById("aliquota_interna").value = "";

            // Limpa a saída
            document.getElementById("referencia-nf").innerHTML = "Referente à nota fiscal: [VALOR_DANFE]";
            document.getElementById("texto_ocorrencia").innerHTML = "Durante operação de fiscalização realizada no Posto Fiscal de Itinga, o condutor apresentou o DANFE listado acima, referente a mercadoria destinada a uma pessoa jurídica ou física não contribuinte do ICMS. Não foi identificado o pagamento do Diferencial de Alíquotas (DIFAL) devido, que deveria ter sido recolhido em favor do Estado do Pará. Em razão disso, foi lavrado o presente termo para cobrança do DIFAL devido. Conforme o artigo 6º da Lei Estadual nº 8.315/2015, o valor do próprio imposto integra sua base de cálculo. Assim, o cálculo do imposto, correspondente à diferença entre a alíquota interna e a interestadual, seguirá os artigos 6º e 7º da mesma lei, em conformidade com a Cláusula Segunda, §1º, do Convênio ICMS 236/2021, combinada com o §1º do artigo 13 da Lei Complementar nº 87/1996.";
            document.getElementById("calculo_difal").innerHTML = "";
            setTimeout(() => {
                document.getElementById('nf-1').focus();
            }, 10);
        }

        // Função para voltar à página anterior
        function voltarPaginaAnterior() {
            window.location.href = "capa.html";
        }

        // Atualiza o texto com base nos dados inseridos
        function atualizarTexto() {
            let notasFiscais = [];
            const notas = document.querySelectorAll(".nota-section");

            // Coleta os números das notas fiscais
            notas.forEach((nota, index) => {
                const i = index + 1;
                const nf = document.getElementById(`nf-${i}`).value;
                if (nf) notasFiscais.push(nf);
            });

            // Atualiza a linha de referência das notas fiscais
            const referenciaNf = document.getElementById("referencia-nf");
            referenciaNf.innerHTML = notasFiscais.length > 1 
                ? `Referente às notas fiscais: ${notasFiscais.join(', ')}` 
                : `Referente à nota fiscal: ${notasFiscais[0] || "NÃO INFORMADO"}`;

            // Exibe o cálculo do DIFAL
            const calculoDifalDiv = document.getElementById("calculo_difal");
            let aliquotaInterna = document.getElementById("aliquota_interna").value || "19";
            aliquotaInterna = parseFloat(aliquotaInterna.replace(/[^0-9.,]/g, '').replace('.', '').replace(',', '.')) / 100 || 0.19;

            let totalValor = 0, totalIcmsDestacado = 0, totalBaseInter = 0, totalBaseDifal = 0, totalIcmsInterno = 0, totalIcmsDifal = 0;
            let aliquotasTodas = [];
            let ufsOrigem = new Set();

            const calculoNotas = document.querySelectorAll(".calculo-section");
            calculoNotas.forEach((nota, index) => {
                const i = index + 1;
                // Normaliza os valores monetários
                let valorTotal = document.getElementById(`valor_total-${i}`).value || "0";
                valorTotal = parseFloat(valorTotal.replace(/[^0-9.,]/g, '').replace('.', '').replace(',', '.')) || 0;

                let icmsDestacado = document.getElementById(`icms_destacado-${i}`).value || "0";
                icmsDestacado = parseFloat(icmsDestacado.replace(/[^0-9.,]/g, '').replace('.', '').replace(',', '.')) || 0;

                const ufOrigem = document.getElementById(`uf_origem-${i}`).value || "NÃO INFORMADO";
                ufsOrigem.add(ufOrigem);
                const aliquotas = document.querySelectorAll(`#aliquotas-${i} .aliquota-section`);
                let aliquotasNota = [];

                aliquotas.forEach((aliquota, aIndex) => {
                    const aId = aIndex + 1;
                    let aliquotaInter = document.getElementById(`aliquota_inter-${i}-${aId}`).value || "0";
                    aliquotaInter = parseFloat(aliquotaInter.replace(/[^0-9.,]/g, '').replace('.', '').replace(',', '.')) || 0;
                    aliquotasNota.push(aliquotaInter);
                });

                if (index === 0) {
                    // Primeira NF: adiciona todas as alíquotas
                    aliquotasNota.forEach(aliquota => {
                        aliquotasTodas.push(formatarPercentual(aliquota));
                    });
                } else {
                    // Demais NFs: adiciona apenas alíquotas diferentes
                    aliquotasNota.forEach(aliquota => {
                        const formattedAliquota = formatarPercentual(aliquota);
                        if (!aliquotasTodas.includes(formattedAliquota)) {
                            aliquotasTodas.push(formattedAliquota);
                        }
                    });
                }

                const baseInter = valorTotal - icmsDestacado;
                const baseDifal = baseInter / (1 - aliquotaInterna);
                const icmsInterno = baseDifal * aliquotaInterna;
                const icmsDifal = icmsInterno - icmsDestacado;

                totalValor += valorTotal;
                totalIcmsDestacado += icmsDestacado;
                totalBaseInter += baseInter;
                totalBaseDifal += baseDifal;
                totalIcmsInterno += icmsInterno;
                totalIcmsDifal += icmsDifal;
            });

            const textoCalculo = `
                <h3>Metodologia de Cálculo do ICMS Diferencial de Alíquota (Art. 7º, incisos I a IV, Lei Estadual nº 8.315/2015)</h3>
                <p>Unidade da Federação/Região de Origem: ${Array.from(ufsOrigem).join(', ')}</p>
                <p>A - Base de Cálculo = Valor Total da Operação Interestadual (incluindo produto, IPI, frete, seguro e outras despesas): ${formatarReais(totalValor)}</p>
                <p>B - Alíquota Interestadual: ${aliquotasTodas.join(' e ')}</p>
                <p>C - ICMS Destacado (C = A × B): ${formatarReais(totalIcmsDestacado)}</p>
                <p>D - Base de Cálculo Interestadual (Art. 7º, inciso I, D = A - C): ${formatarReais(totalBaseInter)}</p>
                <p>E - Base de Cálculo do DIFAL (Art. 7º, inciso II, E = D / (1 - ${formatarPercentual(aliquotaInterna * 100)})): ${formatarReais(totalBaseDifal)}</p>
                <p>F - ICMS Interno (Art. 7º, inciso III, F = E × ${formatarPercentual(aliquotaInterna * 100)}): ${formatarReais(totalIcmsInterno)}</p>
                <p>G - ICMS DIFAL (Art. 7º, inciso IV, G = F - C): ${formatarReais(totalIcmsDifal)}</p>`;

            calculoDifalDiv.innerHTML = textoCalculo;
        }
    </script>
</body>
</html>